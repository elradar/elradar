---
title: Obteniendo rutas, tiempo y distancia de viajes con Open Source Routing Machine
author: ''
date: '2019-10-25'
slug: obteniendo-rutas-tiempo-y-distancia-de-viajes-con-open-source-routing-machine
categories:
  - paquetes
tags:
  - osrm
  - ruteo
publishdate: '2019-10-25T22:00:29-03:00'
comments: yes
---

_Agradecemos a [Angie Scetta](https://www.linkedin.com/in/mar%C3%ADa-de-los-%C3%A1ngeles-scetta-b7b82a80/), arquitecta (UBA) y maestranda en Economía Urbana (UTDT), que nos muestra cómo usar `OSRM`: el paquete de R que permite estimar trayectos, tiempos y distancias de viaje a través de la grilla de calles de cualquier parte del mundo._

_Angie se especializa en análisis de datos urbanos. Trabaja en el Gobierno de la Ciudad de Buenos Aires analizando el impacto de proyectos de diversas áreas de gobierno, y como profesora asistente en la materia Ciencia de Datos para Ciudades en la Universidad Torcuato Di Tella_

### *Analizando recorridos y distancias en la Ciudad*

<div class=text-justify>

A continuación vamos a ver un ejemplo de aplicación del servicio de ruteo de "OSRM" (http://project-osrm.org/), un paquete de uso libre, basado en datos de OpenStreetMap, que es muy útil a la hora de calcular distancias (km) y tiempos de viaje (minutos) entre 2 o más puntos georreferenciados.

El paquete se compone de 4 funciones que son:

* osrmTable(): matriz de tiempos de viaje entre puntos.
* osrmRoute(): camino más corto entre 2 puntos.
* osrmTrip(): viaje entre múltiples puntos.
* osrmIsochrone(): polígonos de isocronas.

En este caso vamos a calcular el camino más corto entre 2 puntos con la función osrmRoute().

Para comenzar, vamos a cargar las librerías requeridas: "tidyverse", "sf", "leaflet" y obviamente, "osrm".

</div>

```{r warning=FALSE, results="hide", error=FALSE, message=FALSE}
library(tidyverse)
library(sf)
library(leaflet)
library(osrm)
```

<div class=text-justify>

Lo siguiente que debemos hacer es elegir cuáles serán nuestros puntos de origen y de destino. Para esto vamos a aprovechar los dataset disponibles en el Portal de Datos Abiertos de la Ciudad http://https://data.buenosaires.gob.ar/ utilizando la ubicación de hospitales públicos (formato CSV) y los polígonos de los barrios de la Ciudad (formato geoJSON). Como ambos archivos tienen información geográfica vamos a poder ubicarlos en el espacio y calcular las distancias entre ellos.

</div>

```{r warning=FALSE, results="hide", error=FALSE, message=FALSE}
barrios <- st_read("http://cdn.buenosaires.gob.ar/datosabiertos/datasets/barrios/barrios.geojson")
hospitales <- read.csv("http://cdn.buenosaires.gob.ar/datosabiertos/datasets/hospitales/hospitales.csv",
                       encoding="UTF-8") %>%
                       mutate(nombre=as.character(nombre))
```

<div class=text-justify>

¿Cómo podemos calcular la distancia y tiempo de viaje que hay entre los barrios de la Ciudad y los hospitales públicos?
Para simplificar la tarea, tomemos 2 barrios como ejemplo: uno céntrico como Palermo y otro más periférico como Villa Lugano y calculemos la distancia y tiempo de viaje (en auto) que existe entre estos y cada hospital.
Entonces, nuestros puntos de origen serán los centroides de ambos barrios y los de destino la ubicación exacta de los 36 hospitales.

Los centroides podemos calcularlos fácilmente con la función st_centroid() del paquete sf y la geometría podemos transformarla en coordenadas X e Y a partir de st_coordinates(). Esta última operación es necesaria para el posterior ruteo.

</div>

```{r warning=FALSE, results="hide", error=FALSE, message=FALSE}
barrios_centroides <- barrios %>%
  st_centroid() %>%
  filter(barrio=="PALERMO" | barrio=="VILLA LUGANO") %>%
  mutate(ubicacion=if_else(barrio=="PALERMO", "CENTRO", "PERIFERIA"))

barrios_centroides <- cbind(barrios_centroides, st_coordinates(barrios_centroides)) %>%
                      st_set_geometry(NULL) %>% 
                      rename(LON_ORIGEN=X,
                             LAT_ORIGEN=Y)
```

__Mapa 1.__
```{r warning=FALSE, error=FALSE, message=FALSE}
hospitales %>% 
  group_by(barrio) %>% 
  summarise(cantidad=n()) %>%
  mutate(barrio=toupper(barrio)) %>% 
  left_join(barrios, by="barrio") %>%
  ungroup() %>% 
ggplot()+
  geom_sf(data=barrios, fill="gray90", color="white")+
  geom_sf(aes(fill=cantidad, geometry = geometry), color="white")+
  geom_point(data=barrios_centroides, aes(x=LON_ORIGEN, y=LAT_ORIGEN, color=ubicacion), shape=4, stroke=2, size=2)+
  geom_point(data=hospitales, aes(x=long, y=lat), size=1.5)+
  scale_fill_gradient(low="gold", high= "deeppink4")+
  scale_color_manual(values = c("turquoise4", "magenta4"))+
  labs(title = "Hospitales públicos por barrio",
         fill="",
         color="",
          x="",
          y="",
         caption= "Fuente: Elaboración propia en base a datos de BAData")+
  theme(panel.background = element_rect(fill = "gray100", colour = "gray100", size = 2, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = "dashed", colour = "gray80"),
        title=element_text(size=10, face = "bold"), plot.title = element_text(hjust = 0.5),
        legend.key.size = unit(0.6, "cm"), legend.key.width = unit(0.5,"cm"),
        legend.text=element_text(size=7),
        plot.caption=element_text(face = "italic", colour = "gray35",size=6),
        axis.text = element_blank(), axis.ticks = element_blank())
```

<div class=text-justify>

En el Mapa 1 podemos ver como se distribuyen los hospitales de la Ciudad (más de la mitad de los barrios no poseen hospitales) y donde se localizan los 2 centroides a analizar.

Ahora sí, para los ruteos, vamos a necesitar crear una función con osrmRoute() que haga los cálculos entre nuestros puntos de origen (centroides de los 2 barrios) y los de destino (hospitales).

ATENCIÓN: Como estamos usando 2 orígenes pero múltiples destinos, es necesario que creemos una función que haga los múltiples ruteos a la vez. Sino deberíamos hacer uno por uno a mano y sería muy engorroso.

</div>

__Generemos la función de ruteo__

<div class=text-justify>

En la función vamos a calcular las 2 nuevas variables que nos interesan: distancias y duración de viajes. Para esto ajustamos algunos argumentos como "returnclass" que hace referencia al tipo de objeto que queremos que nos devuelva la función, en este caso, un objeto espacial "sf"; y "overview" que hace referencia a la calidad con la que se genera la nueva geometría, en este caso utilizaremos la de mayor precisión que es "full".

</div>

```{r warning=FALSE, results="hide", error=FALSE, message=FALSE}
ruteo_hospitales <- function(o_nombre, o_x, o_y, d_nombre, d_x, d_y) {
  ruta <- osrmRoute(src = c(o_nombre, o_x, o_y),
                    dst = c(d_nombre, d_x, d_y), 
                    returnclass = "sf",
                    overview = "full")
  
  cbind(ORIGEN = o_nombre, DESTINO = d_nombre, ruta)
}
```

<div class=text-justify>

Ahora si, solo nos falta un paso para que la función creada se ejecute bien: Generar un dataframe para cada barrio que contenga las variables NOMBRE_ORIGEN, LON_ORIGEN, LAT_ORIGEN, NOMBRE_DESTINO, LON_DESTINO y LAT_DESTINO.
Como verán, ya tenemos todos estos datos, así que es solo cuestión de organizarlos.

</div>

#### __Barrio Céntrico: PALERMO__

```{r error=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
h_palermo <- hospitales %>%
  mutate(NOMBRE_ORIGEN="PALERMO") %>%
  left_join(barrios_centroides, by=c("NOMBRE_ORIGEN"="barrio")) %>%
  rename(NOMBRE_DESTINO=nombre,
         LON_DESTINO=long,
         LAT_DESTINO=lat) %>%
  select(NOMBRE_ORIGEN, LON_ORIGEN, LAT_ORIGEN, NOMBRE_DESTINO, LON_DESTINO, LAT_DESTINO)

head(h_palermo)
```

__A RUTEAR!__

```{r error=FALSE, message=FALSE, warning=FALSE, results="hide", cache=TRUE}
ruteo_palermo <- list(h_palermo$NOMBRE_ORIGEN, h_palermo$LON_ORIGEN,h_palermo$LAT_ORIGEN,
                   h_palermo$NOMBRE_DESTINO, h_palermo$LON_DESTINO,h_palermo$LAT_DESTINO)

ruteo_centrico <- pmap(ruteo_palermo, ruteo_hospitales) %>% 
  reduce(rbind)
```

Ya tenemos los primeros datos de Palermo. Revisemos los resultados.

```{r warning=FALSE, error=FALSE, message=FALSE}
ruteo_centrico %>% 
summary()
```

<div class=text-justify>

Efectivamente, se agregaron 2 nuevos campos llamados duration y distance. Podemos ver que:

* La duración promedio de los viajes es de 24 minutos, mientras que la distancia promedio es de 10,6 km.
* El hospital más cercano está a 2,8 km y el más lejano a 30,5 km.
* El Hospital al que se accede en menor tiempo de viaje es en 10,5 minutos y el de mayor es 41 min.

</div>

¿Cuál es el Hospital más cercano al centro de Palermo?

```{r warning=FALSE, error=FALSE, message=FALSE}
filter(ruteo_centrico, distance == min(distance))$DESTINO
```

¿Cuáles son los 10 hospitales que tienen los recorridos de menor distancia?

```{r warning=FALSE, error=FALSE, message=FALSE}
ruteo_centrico <- ruteo_centrico %>% 
  arrange(distance) %>% 
  head(10) %>% 
  left_join(h_palermo, by=c("DESTINO"="NOMBRE_DESTINO")) %>% 
  mutate(RUTA = paste("Desde", ORIGEN,"hasta", DESTINO))

ruteo_centrico$DESTINO
```

LISTO! Ya logramos lo que queríamos, y podemos decir a que distancia y tiempo de viaje está cada hospital. Pero, no nos conformemos con esto. Aprovechemos la magia de leaflet() para ver toda está información en un lindo mapa interactivo.

__Mapa 2.__ _Rutas calculadas desde Palermo hasta los 10 hospitales públicos de la Ciudad más cercanos_
```{r warning=FALSE, error=FALSE, message=FALSE}
paleta <- c(low="gold", high= "deeppink4")

icons_d <- awesomeIcons(icon = "hospital-o",
                      iconColor = "black",
                      library = "fa",
                      markerColor = "red")

icons_o <- awesomeIcons(icon = "whatever",
                      iconColor = "black",
                      library = "fa",
                      markerColor = "gray")

labels <- sprintf(
  "<strong>%s</strong><br/>%g km <br/>%g min",
  ruteo_centrico$RUTA, round(ruteo_centrico$distance, 2), round(ruteo_centrico$duration, 0)
) %>% lapply(htmltools::HTML)

mapa1 <- leaflet(ruteo_centrico) %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB) %>%
  addPolylines(color = ~colorNumeric(paleta, ruteo_centrico$distance)(distance),
               weight = 6,
               label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "2px 5px"),
      textsize = "10px",
      direction = "top"),
              highlight = highlightOptions(weight = 8,
                                           bringToFront = TRUE)) %>% 
  addLegend("bottomright", pal = colorNumeric(paleta, ruteo_centrico$distance), values = ~distance,
            title = "Distancia",
            labFormat = labelFormat(suffix = "km"),
            opacity = 0.75) %>%
  addAwesomeMarkers(~LON_DESTINO, ~LAT_DESTINO, popup = ~DESTINO, icon=icons_d)%>%
  addAwesomeMarkers(~LON_ORIGEN, ~LAT_ORIGEN, popup = ~ORIGEN, icon=icons_o)
```

```{r eval=FALSE, echo=FALSE}
htmlwidgets::saveWidget(mapa, file = "../../public/widgets/angie_mapa_palermo.html")
```

```{r eval=FALSE}
mapa1
```

<iframe height=400 width=1200 src='/widgets/angie_mapa_palermo.html'> </iframe>

__Ahora repitamos el proceso con Villa Lugano a ver que ocurre__

#### __Barrio Periférico: VILLA LUGANO__

```{r warning=FALSE, error=FALSE, message=FALSE}
h_lugano <- hospitales %>%
  mutate(NOMBRE_ORIGEN="VILLA LUGANO") %>%
  left_join(barrios_centroides, by=c("NOMBRE_ORIGEN"="barrio")) %>%
  rename(NOMBRE_DESTINO=nombre,
         LON_DESTINO=long,
         LAT_DESTINO=lat) %>%
  select(NOMBRE_ORIGEN, LON_ORIGEN, LAT_ORIGEN, NOMBRE_DESTINO, LON_DESTINO, LAT_DESTINO)

head(h_lugano)
```

```{r error=FALSE, message=FALSE, warning=FALSE, results="hide"}
ruteo_lugano <- list(h_lugano$NOMBRE_ORIGEN, h_lugano$LON_ORIGEN,h_lugano$LAT_ORIGEN,
                   h_lugano$NOMBRE_DESTINO, h_lugano$LON_DESTINO,h_lugano$LAT_DESTINO)

ruteo_periferico <- pmap(ruteo_lugano, ruteo_hospitales) %>% 
  reduce(rbind)
```

```{r error=FALSE, message=FALSE, warning=FALSE}
ruteo_periferico %>% 
  summary()
```

<div class=text-justify>

En este caso podemos ver que:
*La duración promedio de los viajes es de 22 minutos, mientras que la distancia promedio es de 12,9 km.
* El hospital más cercano está a 2,67 km y el más lejano a 28,18 km.
* El Hospital al que se accede en menor tiempo de viaje es en 7,6 minutos y el de mayor es 37 minutos.

</div>

¿Cuál es el Hospital más cercano al centro de Villa Lugano?

```{r warning=FALSE, error=FALSE, message=FALSE}
filter(ruteo_periferico, distance == min(distance))$DESTINO
```

¿Cuáles son los 10 hospitales que tienen los recorridos de menor distancia?

```{r warning=FALSE, error=FALSE, message=FALSE}
ruteo_periferico <- ruteo_periferico %>% 
  arrange(distance) %>% 
  head(10) %>% 
  left_join(h_lugano, by=c("DESTINO"="NOMBRE_DESTINO")) %>% 
  mutate(RUTA = paste("Desde", ORIGEN,"hasta", DESTINO))

ruteo_periferico$DESTINO
```

__Mapa 3.__ _Rutas calculadas desde Villa Lugano hasta los 10 hospitales públicos de la Ciudad más cercanos_
```{r warning=FALSE, error=FALSE, message=FALSE}
labels <- sprintf(
  "<strong>%s</strong><br/>%g km <br/>%g min",
  ruteo_periferico$RUTA, round(ruteo_periferico$distance, 2), round(ruteo_periferico$duration, 0)
) %>% lapply(htmltools::HTML)

mapa2 <- leaflet(ruteo_periferico) %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB) %>%
  addPolylines(color = ~colorNumeric(paleta, ruteo_periferico$distance)(distance),
              label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "2px 5px"),
      textsize = "10px",
      direction = "top")) %>% 
  addLegend("bottomright", pal = colorNumeric(paleta, ruteo_periferico$distance), values = ~distance,
            title = "Distancia",
            labFormat = labelFormat(suffix = "km"),
            opacity = 0.75)%>%
  addAwesomeMarkers(~LON_DESTINO, ~LAT_DESTINO, popup = ~DESTINO, icon=icons_d)%>%
  addAwesomeMarkers(~LON_ORIGEN, ~LAT_ORIGEN, popup = ~ORIGEN, icon=icons_o)
```

```{r eval=FALSE, echo=FALSE}
htmlwidgets::saveWidget(mapa, file = "../../public/widgets/angie_mapa_lugano.html")
```

```{r eval=FALSE}
mapa2
```

<iframe height=400 width=1200 src='/widgets/angie_mapa_lugano.html'> </iframe>


<div class=text-justify>

__LISTO! Objetivo cumplido. Hicimos la función de ruteo y la ejecutamos entre 2 barrios de la Ciudad y los 36 hospitales públicos.__

</div>